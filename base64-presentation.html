<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>The Perils of Cross-Domain, Base64-Encoded, Clojure-Enabled Image Importing</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="The Perils of Cross-Domain, Base64-Encoded, Clojure-Enabled Image Importing"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-04-25"/>
<meta name="author" content="Tim Visher"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>

<link rel="stylesheet" type="text/css" href="common.css" />
<link rel="stylesheet" type="text/css" href="screen.css" media="screen" />
<link rel="stylesheet" type="text/css" href="projection.css" media="projection" />
<link rel="stylesheet" type="text/css" href="presenter.css" media="presenter" />


</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">The Perils of Cross-Domain, Base64-Encoded, Clojure-Enabled Image Importing</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Hello Monetate, I'm Tim</a></li>
<li><a href="#sec-2">2 Relay Network</a></li>
<li><a href="#sec-3">3 I Have a Passion …</a></li>
<li><a href="#sec-4">4 … and a Problem</a></li>
<li><a href="#sec-5">5 Wallpaperrr</a>
<ul>
<li>
<ul>
<li><a href="#sec-5-1">5.1 What is Wallpaperrr?</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-6">6 Context</a>
<ul>
<li><a href="#sec-6-1">6.1 slide notes</a></li>
</ul>
</li>
<li><a href="#sec-7">7 <code>POST</code> an Image to the server</a>
<ul>
<li>
<ul>
<li><a href="#sec-7-1">7.1 notes</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-8">8 A better <code>POST</code> body?</a>
<ul>
<li>
<ul>
<li><a href="#sec-8-1">8.1 notes</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-9">9 Obtaining the JSON</a>
<ul>
<li><a href="#sec-9-1">9.1 The Process</a></li>
<li><a href="#sec-9-2">9.2 The bookmarklet</a>
<ul>
<li><a href="#sec-9-2-1">9.2.1 our bootstraperr</a></li>
</ul>
</li>
<li><a href="#sec-9-3">9.3 The Scraper</a>
<ul>
<li><a href="#sec-9-3-1">9.3.1 Calling the scraper</a></li>
</ul>
</li>
<li><a href="#sec-9-4">9.4 The Scraper</a>
<ul>
<li><a href="#sec-9-4-1">9.4.1 Selecting a scraper</a></li>
</ul>
</li>
<li><a href="#sec-9-5">9.5 The Scraper</a>
<ul>
<li><a href="#sec-9-5-1">9.5.1 The dispatch table</a></li>
</ul>
</li>
<li><a href="#sec-9-6">9.6 The Scraper</a>
<ul>
<li><a href="#sec-9-6-1">9.6.1 The anatomy of a scraper</a></li>
</ul>
</li>
<li><a href="#sec-9-7">9.7 Set Up Message Handlers</a></li>
<li><a href="#sec-9-8">9.8 Insert the <code>iframe</code></a>
<ul>
<li><a href="#sec-9-8-1">9.8.1 Insert an iframe responsible for delivering that data to Wallpaperrr and then allowing the user to rate and tag it.</a></li>
</ul>
</li>
<li><a href="#sec-9-9">9.9 <code>postMessage</code> to site</a></li>
<li><a href="#sec-9-10">9.10 <code>postMessage</code> to site</a></li>
<li><a href="#sec-9-11">9.11 <code>postMessage</code> to Wallpaperrr</a></li>
<li><a href="#sec-9-12">9.12 A fork</a></li>
<li><a href="#sec-9-13">9.13 What we've got</a>
<ul>
<li><a href="#sec-9-13-1">9.13.1 notes</a></li>
</ul>
</li>
<li><a href="#sec-9-14">9.14 <code>POST</code> Import Data (sans Base64)</a>
<ul>
<li><a href="#sec-9-14-1">9.14.1 Nothing much to do here</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-10">10 Using the JSON</a>
<ul>
<li><a href="#sec-10-1">10.1 Basic Notes</a></li>
<li><a href="#sec-10-2">10.2 The Back End Process</a>
<ul>
<li><a href="#sec-10-2-1">10.2.1 The Back End Process</a></li>
</ul>
</li>
<li><a href="#sec-10-3">10.3 The Back End Process</a>
<ul>
<li><a href="#sec-10-3-1">10.3.1 An importable wallpaper</a></li>
</ul>
</li>
<li><a href="#sec-10-4">10.4 A Ring App</a>
<ul>
<li><a href="#sec-10-4-1">10.4.1 Anatomy of a Ring App</a></li>
</ul>
</li>
<li><a href="#sec-10-5">10.5 A Compojure Route</a>
<ul>
<li><a href="#sec-10-5-1">10.5.1 Anatomy of a Compojure route</a></li>
</ul>
</li>
<li><a href="#sec-10-6">10.6 The Transaction Script</a>
<ul>
<li>
<ul>
<li><a href="#sec-10-6-1">10.6.1 The Transaction Script</a></li>
</ul>
</li>
<li><a href="#sec-10-6-1">10.6.1 Expanding the source URIs</a>
<ul>
<li><a href="#sec-10-6-1-1">10.6.1.1 Expanding the source URIs</a></li>
</ul>
</li>
<li><a href="#sec-10-6-2">10.6.2 source-uris-&gt;importable-wallpaper</a></li>
<li><a href="#sec-10-6-3">10.6.3 source-uris-&gt;importable-wallpaper</a></li>
<li><a href="#sec-10-6-4">10.6.4 source-uris-&gt;importable-wallpaper</a></li>
<li><a href="#sec-10-6-5">10.6.5 source-uris-&gt;importable-wallpaper</a></li>
<li><a href="#sec-10-6-6">10.6.6 Add to the user's library</a></li>
<li><a href="#sec-10-6-7">10.6.7 Download Each source URI</a></li>
<li><a href="#sec-10-6-8">10.6.8 Thumbnailization</a></li>
<li><a href="#sec-10-6-9">10.6.9 Thumbnailization</a></li>
<li><a href="#sec-10-6-10">10.6.10 Delete the Temporary Files</a></li>
</ul>
</li>
<li><a href="#sec-10-7">10.7 Send the Response</a></li>
</ul>
</li>
<li><a href="#sec-11">11 But what about Base64?</a>
<ul>
<li><a href="#sec-11-1">11.1 notes</a></li>
<li><a href="#sec-11-2">11.2 The Punchline</a>
<ul>
<li><a href="#sec-11-2-1">11.2.1 How to get Same Origin image data to the back end and imported.</a></li>
</ul>
</li>
<li><a href="#sec-11-3">11.3 Client-Side Concerns</a>
<ul>
<li><a href="#sec-11-3-1">11.3.1 Base64 encoding</a></li>
<li><a href="#sec-11-3-2">11.3.2 Base64 encoding</a></li>
<li><a href="#sec-11-3-3">11.3.3 Base64 encoding</a>
<ul>
<li><a href="#sec-11-3-3-1">11.3.3.1 notes</a></li>
</ul>
</li>
<li><a href="#sec-11-3-4">11.3.4 I don't fully understand what the Same Origin Policy effects. In my case, I could load an image but the image's origin-clean flag was set to false and thus I couldn't actually obtain the image data.</a></li>
</ul>
</li>
<li><a href="#sec-11-4">11.4 Server-Side Concerns</a>
<ul>
<li><a href="#sec-11-4-1">11.4.1 Decoding Base64 data</a></li>
<li><a href="#sec-11-4-2">11.4.2 Decoding Base64 data</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-12">12 Setting a URLConnection's User-Agent string</a></li>
<li><a href="#sec-13">13 Further experiments</a></li>
<li><a href="#sec-14">14 In Conclusion</a></li>
<li><a href="#sec-15">15 Thanks! Questions?</a></li>
<li><a href="#sec-16">16 </a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Hello Monetate, I'm Tim &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-1">


<p>
  <img src="images/avatar.jpg"  alt="images/avatar.jpg" />
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Relay Network &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-2">


<p>
  <img src="images/rly201.png"  alt="images/rly201.png" />
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> I Have a Passion … &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-3">


<p>
  <img src="images/wallpaperrr-icon.png"  alt="images/wallpaperrr-icon.png" />
</p>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> … and a Problem &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-4">


<p>
  <img src="images/the-problem.png"  alt="images/the-problem.png" />
</p>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Wallpaperrr &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-5">


<blockquote>

<p>A community of curators passionate about their wallpaper.
</p>
</blockquote>


<p>
  <img src="images/wallpaperrr.png"  alt="images/wallpaperrr.png" />
</p>

</div>

<div id="outline-container-5-1" class="outline-4">
<h4 id="sec-5-1"><span class="section-number-4">5.1</span> What is Wallpaperrr? &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-5-1">

<ul>
<li>A service intended to make it dead simple to import images to a library. Think Instapaper or Evernote.
</li>
<li>A manager for your wallpaper collection across all devices with differing screen resolutions and storage capacities.
</li>
<li>A suite of apps that allow you to deftly control how and where your wallpaper will appear.
</li>
<li>A community of people sharing their passion for ascetics together.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Context &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-6">


<ul>
<li>Import Strategy
</li>
<li><a href="http://www.thefoxisblack.com/category/the-desktop-wallpaper-project/">The Fox Is Black</a>
</li>
<li>A Failed Experiment Which Taught Me Something Anyway
</li>
</ul>



</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> slide notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-6-1">


<ul>
<li>Import Strategy
<ul>
<li>Always bothers me just a little that I'm hitting the server directly from mine.
</li>
<li>The client already has the data (at least on Wallbase). Why not distribute the load?
</li>
<li>Till now, 'ain't broke'

</li>
</ul>

</li>
<li>The Fox Is Black

<ul>
<li>Imports stopped working.

</li>
<li>403s on the back end while the front-end worked just fine.

</li>
<li>Nothing obvious but there were a number of suspicious cookies and they had just done a redesign. I suspected lock out.

</li>
</ul>

</li>
<li>A Failed Experiment

<ul>
<li>Client-Side Image Downloading (Base64)

</li>
<li>Don't Be Evil (especially to Wallbase)

</li>
<li>Let's run an experiment!
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> <code>POST</code> an Image to the server &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-7">





<pre class="src src-js">{
  <span style="color: #00cdcd;">'title'</span>: <span style="color: #00cdcd;">'foo'</span>,
  <span style="color: #00cdcd;">'source'</span>: <span style="color: #00cdcd;">'http://localhost/foo/'</span>,
  <span style="color: #00cdcd;">'sourceUri'</span>: [
    <span style="color: #00cdcd;">'http://localhost/foo_1920x1080.png'</span>,
    <span style="color: #00cdcd;">'http://localhost/foo_1280x800.png'</span>
  ]
}
</pre>



</div>

<div id="outline-container-7-1" class="outline-4">
<h4 id="sec-7-1"><span class="section-number-4">7.1</span> notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-7-1">


<ul>
<li>Basic functionality is fine. Simply download each sourceUri on the back end
</li>
<li>Downsides
<ul>
<li>Risk getting black-listed if you become popular
</li>
<li>Can be bad for the receiving server to be hit twice for the same image (wallbase.cc)
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> A better <code>POST</code> body? &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-8">





<pre class="src src-js">{
  <span style="color: #00cdcd;">'title'</span>: <span style="color: #00cdcd;">'foo'</span>,
  <span style="color: #00cdcd;">'source'</span>: <span style="color: #00cdcd;">'http://localhost/foo/'</span>,
  <span style="color: #00cdcd;">'sourceUri'</span>: [
    <span style="color: #00cdcd;">'iVBORw0KGgoAAA&#8230;ggg=='</span>,
    <span style="color: #00cdcd;">'aBGoAAt0wwgggg&#8230;axx=='</span>
  ]
}
</pre>



</div>

<div id="outline-container-8-1" class="outline-4">
<h4 id="sec-8-1"><span class="section-number-4">8.1</span> notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-8-1">


<ul>
<li>Advantages

<ul>
<li>Get's me the image data directly from the client, which already has the data!

</li>
<li>Offloads downloading the image to the client, which saves me from getting black-listed

</li>
</ul>

</li>
<li>Disadvantages

<ul>
<li>Client's with low-bandwidth get hammered.

</li>
<li>Same Origin Policy!
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Obtaining the JSON &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-9">


<p>
  <img src="images/front-end-process.png"  alt="images/front-end-process.png" />
</p>

</div>

<div id="outline-container-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> The Process &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-9-1">


<ul>
<li>The Process
<ul>
<li>Insert a script from Wallpaperrr into source site
</li>
<li>Scrape site for a title, source, and sourceUri(s)
</li>
<li><code>onload</code> of the iframe, post <code>gimme-data</code> message to <code>window.parent</code>
</li>
<li>on <code>gimme-data</code> message, post <code>import-data</code> message back to <code>event.source</code>
<ul>
<li>Actually, there's a fork here. We can either gather up the sourceURIs directly and do nothing else, or we can grab canvas data.
</li>
</ul>

</li>
<li>on <code>import-data</code> message, <code>POST</code> <code>import-data</code> JSON back to server
</li>
</ul>

</li>
</ul>


</div>

</div>

<div id="outline-container-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> The bookmarklet</h3>
<div class="outline-text-3" id="text-9-2">





<pre class="src src-js"><span style="color: #00cd00;">var</span> <span style="color: #0000ee;">d</span>=document,
    z=d.createElement(<span style="color: #00cdcd;">'src'</span>+<span style="color: #00cdcd;">'ipt'</span>),
    b=d.body;

<span style="color: #00cd00;">if</span>(!b) {
  <span style="color: #00cd00;">throw</span> (0);
}
z.setAttribute(<span style="color: #00cdcd;">'src'</span>,<span style="color: #00cdcd;">'http://localhost:3000/js/import.js'</span>);
b.appendChild(z);

</pre>



</div>

<div id="outline-container-9-2-1" class="outline-4">
<h4 id="sec-9-2-1"><span class="section-number-4">9.2.1</span> our bootstraperr</h4>
<div class="outline-text-4" id="text-9-2-1">


<ul>
<li>responsible for scraping the site
<ul>
<li>as it's loaded into the window's DOM directly, it has access to it
</li>
</ul>

</li>
<li>responsible for inserting the iframe it will be talking to
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> The Scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-3">





<pre class="src src-js">wallpaperrrScraper.scrapeSite = <span style="color: #00cd00;">function</span> () {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">siteScraper</span>;

  siteScraper = wallpaperrrScraper.matchingScraper();

  <span style="color: #00cd00;">return</span> siteScraper ? siteScraper() : wallpaperrrScraper.defaultScraper();
};
</pre>



</div>

<div id="outline-container-9-3-1" class="outline-4">
<h4 id="sec-9-3-1"><span class="section-number-4">9.3.1</span> Calling the scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-3-1">


<ul>
<li>We provide a default scraper.
</li>
<li>A saner language would let me get a key out of a map with a default.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-4" class="outline-3">
<h3 id="sec-9-4"><span class="section-number-3">9.4</span> The Scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-4">





<pre class="src src-js"><span style="color: #5c5cff; font-weight: bold;">// </span><span style="color: #5c5cff; font-style: italic;">man, I want underscore!</span>
wallpaperrrScraper.matchingScraper = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">sitePattern</span>) {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">siteMatch</span>;
  <span style="color: #00cd00;">for</span> (siteMatch <span style="color: #00cd00;">in</span> wallpaperrrScraper.scraperDispatch) {
    <span style="color: #00cd00;">if</span> (wallpaperrrScraper.scraperDispatch
        .hasOwnProperty(siteMatch)) {
      <span style="color: #00cd00;">if</span> (document.baseURI.match(sitePattern)) {
        <span style="color: #00cd00;">return</span> wallpaperrrScraper.scraperDispatch[siteMatch];
      }
    }
  }
};
</pre>



</div>

<div id="outline-container-9-4-1" class="outline-4">
<h4 id="sec-9-4-1"><span class="section-number-4">9.4.1</span> Selecting a scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-4-1">


<ul>
<li>If I were using underscore, this'd be a lot easier. Que Sera, Sera.
</li>
<li>Remember to use <code>hasOwnProperty</code> if you're iterating over an object's properties.
</li>
<li>Passing a string to <code>match</code> works nicely and allows us to use regexps.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-5" class="outline-3">
<h3 id="sec-9-5"><span class="section-number-3">9.5</span> The Scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-5">





<pre class="src src-js">wallpaperrrScraper.scraperDispatch = {
  <span style="color: #00cdcd;">"thefoxisblack.com"</span>: wallpaperrrScraper.thefoxisblackScraper,
  <span style="color: #00cdcd;">"10.0.0.*"</span>:          wallpaperrrScraper.localhostScraper,
};
</pre>



</div>

<div id="outline-container-9-5-1" class="outline-4">
<h4 id="sec-9-5-1"><span class="section-number-4">9.5.1</span> The dispatch table &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-5-1">


<ul>
<li>Dispatch tables are nice! I picked them up from Relay.

</li>
<li>Anyone can assoc into them, potentially opening up extensions without code redeployment.

</li>
<li>This particular structure is nice because I can use regexps
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-6" class="outline-3">
<h3 id="sec-9-6"><span class="section-number-3">9.6</span> The Scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-6">





<pre class="src src-js">wallpaperrrScraper.thefoxisblackScraper = <span style="color: #00cd00;">function</span> () {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">aNodes</span>, <span style="color: #0000ee;">imageUrls</span>, <span style="color: #0000ee;">i</span>;
  wallpaperrrScraper.title =
    document.querySelector(<span style="color: #00cdcd;">'.post h2 a'</span>).textContent;
  aNodes = document.querySelectorAll(<span style="color: #00cdcd;">'#wallpaper a'</span>);
  imageUrls = [];
  <span style="color: #00cd00;">for</span> (i = 0; i &lt; aNodes.length; i += 1) {
    imageUrls.push(aNodes[i].href);
  }
  wallpaperrrScraper.sourceUri = imageUrls;
  wallpaperrrScraper.merge = <span style="color: #00cdcd;">true</span>;
  wallpaperrrScraper.insertIFrame();
};
</pre>



</div>

<div id="outline-container-9-6-1" class="outline-4">
<h4 id="sec-9-6-1"><span class="section-number-4">9.6.1</span> The anatomy of a scraper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-6-1">


<ul>
<li>I need 3 things: title, source, and the uris.

</li>
<li>Title is used as the title of the wallpaper in your library as well as the name of the wallpaper file on downloading it.

</li>
<li>Source is used to to link back to the source if others want to import that wallpaper.

</li>
<li>Source URIs are used to download the actual wallpapers. Alternatively to the source URIs, I could have a series of base64 strings.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-7" class="outline-3">
<h3 id="sec-9-7"><span class="section-number-3">9.7</span> Set Up Message Handlers &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-7">





<pre class="src src-js">wallpaperrrScraper.messageHandlers = {
  <span style="color: #00cdcd;">'gimme-import-data'</span>: wallpaperrrScraper.postImportDataMessage
};
</pre>


</div>

</div>

<div id="outline-container-9-8" class="outline-3">
<h3 id="sec-9-8"><span class="section-number-3">9.8</span> Insert the <code>iframe</code> &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-8">





<pre class="src src-js">wallpaperrrScraper.insertIFrame = <span style="color: #00cd00;">function</span> () {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">i</span>, <span style="color: #0000ee;">isrc</span>;
  i =  document.createElement(<span style="color: #00cdcd;">'iframe'</span>);
  i.setAttribute(<span style="color: #00cdcd;">'id'</span>, <span style="color: #00cdcd;">'addFrame'</span>);
  i.setAttribute(<span style="color: #00cdcd;">'src'</span>, <span style="color: #00cdcd;">'http://localhost:3000/bookmarklet-import'</span>);
  i.setAttribute(<span style="color: #00cdcd;">'style'</span>, <span style="color: #00cdcd;">'position: fixed; &#8230;'</span>);
  document.body.appendChild(i);
  i.focus();
};
</pre>



</div>

<div id="outline-container-9-8-1" class="outline-4">
<h4 id="sec-9-8-1"><span class="section-number-4">9.8.1</span> Insert an iframe responsible for delivering that data to Wallpaperrr and then allowing the user to rate and tag it. &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-8-1">


<ul>
<li>We position it fixed at the top left so it looks nice and doesn't matter in what context it is inserted in.
</li>
<li>Love that <code>z-index</code>
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-9" class="outline-3">
<h3 id="sec-9-9"><span class="section-number-3">9.9</span> <code>postMessage</code> to site &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-9">





<pre class="src src-js">wallpaperrrBookmarkletImport.doImport = <span style="color: #00cd00;">function</span> () {
  window.addEventListener(
    <span style="color: #00cdcd;">'message'</span>,
    wallpaperrrBookmarkletImport.receiveMessage);
  window.parent.postMessage(
    {
      <span style="color: #00cdcd;">'target'</span>: <span style="color: #00cdcd;">'wallpaperSite'</span>,
      <span style="color: #00cdcd;">'title'</span>: <span style="color: #00cdcd;">'gimme-import-data'</span>
    },
    <span style="color: #00cdcd;">'*'</span>);
};
</pre>


</div>

</div>

<div id="outline-container-9-10" class="outline-3">
<h3 id="sec-9-10"><span class="section-number-3">9.10</span> <code>postMessage</code> to site &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-10">





<pre class="src src-js">wallpaperrrScraper.handleMessage = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">e</span>) {
  <span style="color: #00cd00;">if</span> (<span style="color: #00cdcd;">'wallpaperSite'</span> !== e.data.target) {
    <span style="color: #00cd00;">return</span> <span style="color: #00cdcd;">false</span>;
  }

  <span style="color: #00cd00;">if</span> (messageHandlers[e.data.title]) {
    <span style="color: #00cd00;">return</span> messageHandlers[e.data.title](e, e.data.payload);
  }
}

window.addEventListener(<span style="color: #00cdcd;">'message'</span>, handleMessage);
</pre>


</div>

</div>

<div id="outline-container-9-11" class="outline-3">
<h3 id="sec-9-11"><span class="section-number-3">9.11</span> <code>postMessage</code> to Wallpaperrr &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-11">





<pre class="src src-js">wallpaperrrScraper.postImportDataMessage = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">e</span>) {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">payload</span>;
  payload = {
    <span style="color: #00cdcd;">'title'</span>: self.title,
    <span style="color: #00cdcd;">'sourceUri'</span>: self.sourceUri,
    <span style="color: #00cdcd;">'source'</span>: self.source,
    <span style="color: #00cdcd;">'merge'</span>: self.merge
  };
  e.source.postMessage(payload, <span style="color: #00cdcd;">'*'</span>);
};
</pre>


</div>

</div>

<div id="outline-container-9-12" class="outline-3">
<h3 id="sec-9-12"><span class="section-number-3">9.12</span> A fork &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-12">


<ol>
<li>URIs
</li>
<li>Base64
</li>
</ol>


</div>

</div>

<div id="outline-container-9-13" class="outline-3">
<h3 id="sec-9-13"><span class="section-number-3">9.13</span> What we've got &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-13">





<pre class="src src-js">{
  <span style="color: #00cdcd;">'title'</span>: <span style="color: #00cdcd;">'foo'</span>,
  <span style="color: #00cdcd;">'source'</span>: <span style="color: #00cdcd;">'http://localhost/foo/'</span>,
  <span style="color: #00cdcd;">'sourceUri'</span>: [
    <span style="color: #00cdcd;">'http://localhost/foo_1920x1080.png'</span>,
    <span style="color: #00cdcd;">'http://localhost/foo_1280x800.png'</span>
  ]
}
</pre>



</div>

<div id="outline-container-9-13-1" class="outline-4">
<h4 id="sec-9-13-1"><span class="section-number-4">9.13.1</span> notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-13-1">


<ul>
<li>Basic functionality is fine. Simply download each sourceUri on the back end
</li>
<li>Downsides
<ul>
<li>Risk getting black-listed if you become popular
</li>
<li>Can be bad for the receiving server to be hit twice for the same image (wallbase.cc)
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-9-14" class="outline-3">
<h3 id="sec-9-14"><span class="section-number-3">9.14</span> <code>POST</code> Import Data (sans Base64) &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-9-14">





<pre class="src src-js">wallpaperrrBookmarkletImport.imgsLoaded = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">importData</span>) {
  wallpaperrrBookmarkletImport.importRequest()
    .send(JSON.stringify(importData));
  Wallpaperrr.Functions
    .showElement(
      document.getElementById(<span style="color: #00cdcd;">'importing-header'</span>)
    );
};
</pre>



</div>

<div id="outline-container-9-14-1" class="outline-4">
<h4 id="sec-9-14-1"><span class="section-number-4">9.14.1</span> Nothing much to do here &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-9-14-1">

</div>
</div>
</div>

</div>

<div id="outline-container-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Using the JSON &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-10">


<ul>
<li>A Compojure <code>POST</code> Route
</li>
<li>Some Ring <code>middleware</code>
</li>
<li>Some Clojure <code>multimethods</code>
</li>
<li>javax.imageio.ImageIO
</li>
<li>org.jdesktop.swingx.graphics.GraphicsUtilities
</li>
</ul>



</div>

<div id="outline-container-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Basic Notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-10-1">


<ul>
<li>We support Zip Files, Straight URIS, and now Base64 Strings
</li>
<li>Middleware is cool (apparently comes from Rails?)
</li>
<li>Java's big. Has 'good' image libraries. Can throw out of memory errors when handling large files. This is something I think I'm going to pay someone else to do.
</li>
<li>Core <code>multimethods</code>
<ul>
<li>Requests are handled by <code>multimethods</code> dispatching on the <code>accept-header</code>
</li>
<li>URIs are converted to <code>BufferedImage</code>, dispatching on the <code>class</code> of the input
</li>
<li>Extensions are retrieved, dispatching on <code>class</code>
</li>
</ul>

</li>
</ul>


</div>

</div>

<div id="outline-container-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> The Back End Process &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-2">


<p>
   <img src="images/the-process.png"  alt="images/the-process.png" />
</p>

</div>

<div id="outline-container-10-2-1" class="outline-4">
<h4 id="sec-10-2-1"><span class="section-number-4">10.2.1</span> The Back End Process &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-2-1">


<ul>
<li>The Process
<ol>
<li><code>POST</code> route receives the request and destructures the JSON using middleware into function parameters.
</li>
<li>The <code>POST</code> route multimethod responsible for JSON accept headers takes over, passing the data through to the wallpaper model transaction script namespace
</li>
<li>We expand the source uris, turning Zip files into multiple temporary files
</li>
<li>We transform the expanded source uris into importable wallpapers
</li>
<li>We alter the user's library ref, adding in each wallpaper.
</li>
<li>We save off the state of the library to the store
</li>
<li>We finally download each of the source-uris that made it through the import process into their correlated library-store-ids
</li>
<li>Then we thumbnail-ize them
</li>
<li>And finally delete any temporary files that were created (at this point only in the case of ZipFiles)
</li>
<li>Return the response map.

</li>
</ol>

</li>
<li>We support Zip Files, Straight URIS, and now Base64 Strings
</li>
<li>Core <code>multimethods</code>
<ul>
<li>Requests are handled by <code>multimethods</code> dispatching on the <code>accept-header</code>
</li>
<li>URIs are converted to <code>BufferedImage</code>, dispatching on the <code>class</code> of the input
</li>
<li>Extensions are retrieved, dispatching on <code>class</code>
</li>
</ul>

</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> The Back End Process &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-3">





<pre class="src src-clojure"><span style="color: #5c5cff; font-weight: bold;">;;; </span><span style="color: #5c5cff; font-style: italic;">["http://localhost:3000/user/tim.visher/&#8230;allbase_1920x1080.jpeg"] =&gt;</span>
{<span style="color: #00cdcd;">:wallpaper</span> {<span style="color: #00cdcd;">:thumbnail-resolution</span> {<span style="color: #00cdcd;">:extension</span> <span style="color: #00cdcd;">"jpeg"</span>,
                                    <span style="color: #00cdcd;">:hash</span> <span style="color: #00cdcd;">"f47818e3692786db6737a1b20236ce60"</span>,
                                    <span style="color: #00cdcd;">:width</span> 1920,
                                    <span style="color: #00cdcd;">:height</span> 1080},
             <span style="color: #00cdcd;">:imported-at</span> 1366813210080,
             <span style="color: #00cdcd;">:rating</span> 0,
             <span style="color: #00cdcd;">:source</span> <span style="color: #00cdcd;">"http://localhost:3000/&#8230;"</span>,
             <span style="color: #00cdcd;">:title</span> <span style="color: #00cdcd;">"trees artwork - Wallpaper (#2756701) Wallbase"</span>,
             <span style="color: #00cdcd;">:tags</span> #{<span style="color: #00cdcd;">"16:9"</span> <span style="color: #00cdcd;">"1920x1080"</span>},
             <span style="color: #00cdcd;">:resolutions</span> #{{<span style="color: #00cdcd;">:extension</span> <span style="color: #00cdcd;">"jpeg"</span>, <span style="color: #00cdcd;">:hash</span> <span style="color: #00cdcd;">"&#8230;"</span>, <span style="color: #00cdcd;">:width</span> 1920, <span style="color: #00cdcd;">:height</span> 1080}}}
 <span style="color: #00cdcd;">:source-uri</span> #&lt;<span style="color: #ff0000;">File</span> /var/folders/y7/&#8230;}
</pre>



</div>

<div id="outline-container-10-3-1" class="outline-4">
<h4 id="sec-10-3-1"><span class="section-number-4">10.3.1</span> An importable wallpaper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-3-1">


<ol>
<li>Title should be appropriate for being the name of a file on any file system.
</li>
<li>Resolutions and Aspect Ratios should be added as tags automatically
</li>
<li>We should have hashes of all the files so storage is shared across all users
</li>
<li>Multiple source uris for the same logical 'wallpaper' should be merged together. Others should be kept separate.
</li>
</ol>


</div>
</div>

</div>

<div id="outline-container-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> A Ring App &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-4">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">def</span> <span style="color: #0000ee;">app</span>
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">-&gt;</span> #'routes/main-routes
      &#8230;
      wrap-params
      &#8230;
      wrap-json-params<span style="color: #8a8a8a;">))</span>
</pre>



</div>

<div id="outline-container-10-4-1" class="outline-4">
<h4 id="sec-10-4-1"><span class="section-number-4">10.4.1</span> Anatomy of a Ring App &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-4-1">


<ul>
<li>A Ring app is a function which takes a request in the form of a map and returns a map representing a response.
</li>
<li>This allows the use of higher order functions to construct 'middleware' which either transform the request or response on behalf of all inner routes.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> A Compojure Route &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-5">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">POST</span> <span style="color: #00cdcd;">"/wallpaper"</span> [merge title source <span style="color: #ff0000;">sourceUri</span> <span style="color: #00cdcd;">:as</span> r]
      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [{{{username <span style="color: #00cdcd;">:value</span>} <span style="color: #00cdcd;">"username"</span>} <span style="color: #00cdcd;">:cookies</span>} r]
        <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> username
          <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">letfn</span> [<span style="color: #8a8a8a;">(</span>rep [s] <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">apply</span> str <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">replace</span> {\ , \+} s<span style="color: #8a8a8a;">)))</span>]
            <span style="color: #8a8a8a;">(</span>wallpaper-post-route r
                                  username
                                  title
                                  merge
                                  <span style="color: #8a8a8a;">(</span>rep source<span style="color: #8a8a8a;">)</span>
                                  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">vector?</span> <span style="color: #ff0000;">sourceUri</span><span style="color: #8a8a8a;">)</span>
                                    <span style="color: #8a8a8a;">(</span>mapv rep <span style="color: #ff0000;">sourceUri</span><span style="color: #8a8a8a;">)</span>
                                    <span style="color: #ff0000;">sourceUri</span><span style="color: #8a8a8a;">)))</span>
          {<span style="color: #00cdcd;">:status</span> 401}<span style="color: #8a8a8a;">)))</span>
</pre>




</div>

<div id="outline-container-10-5-1" class="outline-4">
<h4 id="sec-10-5-1"><span class="section-number-4">10.5.1</span> Anatomy of a Compojure route &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-5-1">


<ul>
<li>Compojure is a thin wrapper (started at around 200 SLOC) around constructing Ring handler functions.
</li>
<li>It provides a series of Macros which make it easy to declare what kind of request you're handling, the URL you expect to hit, and how you want to destructure the parameters that can come in.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-10-6" class="outline-3">
<h3 id="sec-10-6"><span class="section-number-3">10.6</span> The Transaction Script &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span>&nbsp;<span class="bigcode">bigcode</span></span></h3>
<div class="outline-text-3" id="text-10-6">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">import-wallpaper</span>
  <span style="color: #8a8a8a;">(</span>[username store-base merge? title source source-uris]
     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [-&gt;importable-wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">partial</span> lib/import-uri-&gt;importable-wallpaper username title source<span style="color: #8a8a8a;">)</span>
           -&gt;sanitized-title      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">fn</span> [wallpaper]
                                    <span style="color: #8a8a8a;">(</span>lib/sanitize-title username <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:title</span> wallpaper<span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:thumbnail-resolution</span> wallpaper<span style="color: #8a8a8a;">)))</span>
           source-uris            <span style="color: #8a8a8a;">(</span>expand-source-uris source-uris<span style="color: #8a8a8a;">)</span>
           importable-wallpapers  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">doall</span>
                                   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> identity <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;importable-wallpaper source-uris<span style="color: #8a8a8a;">)))</span>]
       <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">not</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">empty?</span> importable-wallpapers<span style="color: #8a8a8a;">))</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [source-uris              <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:source-uri</span> importable-wallpapers<span style="color: #8a8a8a;">)</span>
               wallpapers               <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:wallpaper</span> importable-wallpapers<span style="color: #8a8a8a;">)</span>
               sanitized-titles         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;sanitized-title wallpapers<span style="color: #8a8a8a;">)</span>
               shortest-sanitized-title <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">first</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">sort-by</span> count sanitized-title<span style="color: #8a8a8a;">))</span>
               sanitized-title          shortest-sanitized-title
               unique-titles            <span style="color: #8a8a8a;">(</span>lib/unique-titles username sanitized-title<span style="color: #8a8a8a;">)</span>
               wallpapers               <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> %1 <span style="color: #00cdcd;">:title</span> %2<span style="color: #8a8a8a;">)</span> wallpapers unique-titles<span style="color: #8a8a8a;">)</span>
               wallpapers               <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> merge? [<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">reduce</span> merge-wallpapers wallpapers<span style="color: #8a8a8a;">)</span>] wallpapers<span style="color: #8a8a8a;">)</span>]
           <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">partial</span> lib/add-library-wallpaper! username<span style="color: #8a8a8a;">)</span> wallpapers<span style="color: #8a8a8a;">))</span>
           <span style="color: #8a8a8a;">(</span>store/put <span style="color: #00cdcd;">:file-system</span> store-base <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">str</span> <span style="color: #00cdcd;">"libraries/"</span> username <span style="color: #00cdcd;">".clj"</span><span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">pr-str</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">into</span> #{}  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">deref</span> <span style="color: #8a8a8a;">(</span>lib/new-library username<span style="color: #8a8a8a;">)))))</span>
           <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [resolutions          <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">comp</span> <span style="color: #00cdcd;">:thumbnail-resolution</span> <span style="color: #00cdcd;">:wallpaper</span><span style="color: #8a8a8a;">)</span> importable-wallpapers<span style="color: #8a8a8a;">)</span>
                 library-object-ids   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;library-object-id %1 <span style="color: #00cdcd;">"library"</span> %2<span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:wallpaper</span> importable-wallpapers<span style="color: #8a8a8a;">)</span> resolutions<span style="color: #8a8a8a;">)</span>
                 thumbnail-object-ids <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;thumbnail-object-id %1 <span style="color: #00cdcd;">"thumbnails"</span> %2<span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:wallpaper</span> importable-wallpapers<span style="color: #8a8a8a;">)</span> resolutions<span style="color: #8a8a8a;">)</span>]
             <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
              <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">with-open</span> [is <span style="color: #8a8a8a;">(</span>io/input-stream %2<span style="color: #8a8a8a;">)</span>] <span style="color: #8a8a8a;">(</span>store/put <span style="color: #00cdcd;">:file-system</span> store-base %1 is<span style="color: #8a8a8a;">))</span> library-object-ids source-uris<span style="color: #8a8a8a;">))</span>
             <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
              <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">partial</span> store/create-thumbnail <span style="color: #00cdcd;">:file-system</span> store-base<span style="color: #8a8a8a;">)</span> library-object-ids thumbnail-object-ids<span style="color: #8a8a8a;">)))</span>
           <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> fs/delete <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> fs/exists? <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> string? source-uris<span style="color: #8a8a8a;">))))</span>
           wallpapers<span style="color: #8a8a8a;">)</span>
         []<span style="color: #8a8a8a;">))))</span>
</pre>



</div>

<div id="outline-container-10-6-1" class="outline-5">
<h5 id="sec-10-6-1"><span class="section-number-5">10.6.1</span> The Transaction Script &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h5>
<div class="outline-text-5" id="text-10-6-1">


<ul>
<li>An Overview
<ul>
<li>Expand the source URIs
</li>
<li>Transform source URIs to importable wallpaper
</li>
<li>Add importable wallpapers to user lib
</li>
<li>Download each to global file-store
</li>
<li>Add thumbnails for each to global file-store
</li>
<li>Delete temporary files
</li>
</ul>

</li>
<li>I'm creating functions in 4 different ways here. partial, comp, fn, and #(). Yeah, Clojure's functional alright.
<ul>
<li>many are anonymous, 2 are named in the let.
</li>
</ul>

</li>
<li>This is a common pattern for clojure code. Make a let that names each step of your algorithm so you can reference it later.
</li>
<li>Notice dorun/doall. This is because Clojure is lazily evaluated and when you get back to the front-end you won't be able to iterate over the lazyseq.
</li>
</ul>


</div>

</div>

<div id="outline-container-10-6-1" class="outline-4">
<h4 id="sec-10-6-1"><span class="section-number-4">10.6.1</span> Expanding the source URIs &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-1">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">expand-source-uris</span> [source-uris]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">loop</span> [expanded-source-uris       #{}
         [source-uri &amp; source-uris] <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> importable-uri? source-uris<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> source-uri
      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">cond</span> <span style="color: #8a8a8a;">(</span>zipfile? source-uri<span style="color: #8a8a8a;">)</span>
            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">recur</span> expanded-source-uris
                   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">into</span> source-uris <span style="color: #8a8a8a;">(</span>zipfile-uri-&gt;temp-files source-uri<span style="color: #8a8a8a;">)))</span>

            <span style="color: #8a8a8a;">(</span>url-exists? source-uri<span style="color: #8a8a8a;">)</span>
            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">recur</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">conj</span> expanded-source-uris <span style="color: #8a8a8a;">(</span>source-uri-&gt;temp-file source-uri<span style="color: #8a8a8a;">))</span>
                   source-uris<span style="color: #8a8a8a;">)</span>

            <span style="color: #00cdcd;">:drop-it</span>
            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">recur</span> expanded-source-uris source-uris<span style="color: #8a8a8a;">))</span>
      expanded-source-uris<span style="color: #8a8a8a;">)))</span>
</pre>



</div>

<div id="outline-container-10-6-1-1" class="outline-5">
<h5 id="sec-10-6-1-1"><span class="section-number-5">10.6.1.1</span> Expanding the source URIs &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h5>
<div class="outline-text-5" id="text-10-6-1-1">


<ul>
<li>The loop/recur form is the only tail-call optimized form in Clojure. Useful if you can't get your job done using standard list-comprehensions or fold operations
</li>
<li>Clojure supports destructuring binds. Sequences are destructured with vectors, and maps are destructured with maps.
</li>
<li>In the case of a zipfile, we want to drop the original uri and replace it with many temporary files.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-10-6-2" class="outline-4">
<h4 id="sec-10-6-2"><span class="section-number-4">10.6.2</span> source-uris-&gt;importable-wallpaper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-2">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">import-uri-&gt;importable-wallpaper</span>
  <span style="color: #8a8a8a;">(</span>[username title source source-uri]
     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if-let</span> [wallpaper <span style="color: #8a8a8a;">(</span>import-uri-&gt;wallpaper username title source source-uri<span style="color: #8a8a8a;">)</span>]
       {<span style="color: #00cdcd;">:wallpaper</span> wallpaper <span style="color: #00cdcd;">:source-uri</span> source-uri}<span style="color: #8a8a8a;">))</span>
  <span style="color: #8a8a8a;">(</span>[username source-uri]
     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [title <span style="color: #8a8a8a;">(</span>store/base-name <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.getPath</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">java.net.URI.</span> source-uri<span style="color: #8a8a8a;">)))</span>]
       <span style="color: #8a8a8a;">(</span>import-uri-&gt;importable-wallpaper username
                                         title
                                         source-uri
                                         source-uri<span style="color: #8a8a8a;">))))</span>
</pre>


</div>

</div>

<div id="outline-container-10-6-3" class="outline-4">
<h4 id="sec-10-6-3"><span class="section-number-4">10.6.3</span> source-uris-&gt;importable-wallpaper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span>&nbsp;<span class="mediumcode">mediumcode</span></span></h4>
<div class="outline-text-4" id="text-10-6-3">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">import-uri-&gt;wallpaper</span> [username title source source-uri]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if-let</span> [image <span style="color: #8a8a8a;">(</span>wc/uri-&gt;image source-uri<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [wallpaper {<span style="color: #00cdcd;">:resolutions</span> #{<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:resolution</span> image<span style="color: #8a8a8a;">)</span> <span style="color: #00cdcd;">:extension</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:extension</span> image<span style="color: #8a8a8a;">))</span>}}
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:tags</span> #{<span style="color: #8a8a8a;">(</span>wc/resolution-&gt;string <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">first</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:resolutions</span> wallpaper<span style="color: #8a8a8a;">)))</span>}<span style="color: #8a8a8a;">)</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:tags</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">-&gt;&gt;</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:resolutions</span> wallpaper<span style="color: #8a8a8a;">)</span>
                                                <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">first</span> ,,,<span style="color: #8a8a8a;">)</span>
                                                <span style="color: #8a8a8a;">(</span>wc/resolution-&gt;aspect-ratio ,,,<span style="color: #8a8a8a;">)</span>
                                                <span style="color: #8a8a8a;">(</span>wc/aspect-ratio-&gt;string ,,,<span style="color: #8a8a8a;">)</span>
                                                <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">conj</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:tags</span> wallpaper<span style="color: #8a8a8a;">)</span> ,,,<span style="color: #8a8a8a;">)</span>
                                                <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">into</span> #{} ,,,<span style="color: #8a8a8a;">)))</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:title</span> <span style="color: #8a8a8a;">(</span>sanitize-title username title <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">first</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:resolutions</span> wallpaper<span style="color: #8a8a8a;">))))</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:source</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">try</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.toString</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">java.net.URI.</span> source<span style="color: #8a8a8a;">))</span>
                                                  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">catch</span> <span style="color: #ff0000;">java.net.MalformedURLException</span> e<span style="color: #8a8a8a;">)))</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:rating</span> 0<span style="color: #8a8a8a;">)</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:imported-at</span> <span style="color: #8a8a8a;">(</span>time-coerce/to-long <span style="color: #8a8a8a;">(</span>time/now<span style="color: #8a8a8a;">)))</span>
          wallpaper <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> wallpaper <span style="color: #00cdcd;">:thumbnail-resolution</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">first</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:resolutions</span> wallpaper<span style="color: #8a8a8a;">)))</span>]
      wallpaper<span style="color: #8a8a8a;">)))</span>
</pre>


</div>

</div>

<div id="outline-container-10-6-4" class="outline-4">
<h4 id="sec-10-6-4"><span class="section-number-4">10.6.4</span> source-uris-&gt;importable-wallpaper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-4">


<ul>
<li><code>wc/uri-&gt;image</code>




<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmulti</span> <span style="color: #0000ee;">java-image</span> <span style="color: #00cdcd; font-style: italic;">"Attempts to coerce it's argument to a BufferedImage"</span> class<span style="color: #8a8a8a;">)</span>

<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmethod</span> <span style="color: #0000ee;">java-image</span> <span style="color: #ff0000;">BufferedImage</span> [<span style="color: #ff0000;">^BufferedImage</span> image]
  <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">GraphicsUtilities/toCompatibleImage</span> image<span style="color: #8a8a8a;">))</span>

<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmethod</span> <span style="color: #0000ee;">java-image</span> <span style="color: #00cdcd;">:default</span> [input-streamable]
  <span style="color: #8a8a8a;">(</span>input-streamable-&gt;java-image input-streamable<span style="color: #8a8a8a;">))</span>
</pre>

</li>
</ul>


</div>

</div>

<div id="outline-container-10-6-5" class="outline-4">
<h4 id="sec-10-6-5"><span class="section-number-4">10.6.5</span> source-uris-&gt;importable-wallpaper &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-5">


<ul>
<li><code>wc/uri-&gt;image</code>




<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmulti</span> <span style="color: #0000ee;">extensions</span> <span style="color: #00cdcd; font-style: italic;">"Attempts to get image format extensions for INPUT"</span> class<span style="color: #8a8a8a;">)</span>

<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmethod</span> <span style="color: #0000ee;">extensions</span> <span style="color: #00cdcd;">:default</span> [file]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">with-open</span> [is <span style="color: #8a8a8a;">(</span>io/input-stream file<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">-&gt;&gt;</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">ImageIO/createImageInputStream</span> is<span style="color: #8a8a8a;">)</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">ImageIO/getImageReaders</span><span style="color: #8a8a8a;">)</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">iterator-seq</span><span style="color: #8a8a8a;">)</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.getFormatName</span> %<span style="color: #8a8a8a;">))</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.toLowerCase</span> %<span style="color: #8a8a8a;">))</span>
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">into</span> #{}<span style="color: #8a8a8a;">))))</span>
</pre>

</li>
</ul>


</div>

</div>

<div id="outline-container-10-6-6" class="outline-4">
<h4 id="sec-10-6-6"><span class="section-number-4">10.6.6</span> Add to the user's library &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-6">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">partial</span> lib/add-library-wallpaper! username<span style="color: #8a8a8a;">)</span> wallpapers<span style="color: #8a8a8a;">))</span>
<span style="color: #8a8a8a;">(</span>store/put <span style="color: #00cdcd;">:file-system</span>
           store-base
           <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">str</span> <span style="color: #00cdcd;">"libraries/"</span> username <span style="color: #00cdcd;">".clj"</span><span style="color: #8a8a8a;">)</span>
           <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">pr-str</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">into</span> #{}  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">deref</span> <span style="color: #8a8a8a;">(</span>lib/new-library username<span style="color: #8a8a8a;">)))))</span>
</pre>


</div>

</div>

<div id="outline-container-10-6-7" class="outline-4">
<h4 id="sec-10-6-7"><span class="section-number-4">10.6.7</span> Download Each source URI &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-7">






<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [-&gt;thumbnail-resolution <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">comp</span> <span style="color: #00cdcd;">:thumbnail-resolution</span> <span style="color: #00cdcd;">:wallpaper</span><span style="color: #8a8a8a;">)</span>
      resolutions            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;thumbnail-resolution importable-wallpapers<span style="color: #8a8a8a;">)</span>
      wallpapers             <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:wallpaper</span> importable-wallpapers<span style="color: #8a8a8a;">)</span>
      -&gt;library-object-id    #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;library-object-id %1 <span style="color: #00cdcd;">"library"</span> %2<span style="color: #8a8a8a;">)</span>
      library-object-ids     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;library-object-id wallpapers resolutions<span style="color: #8a8a8a;">)</span>
      -&gt;thumbnail-object-id  #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;thumbnail-object-id %1 <span style="color: #00cdcd;">"thumbnails"</span> %2<span style="color: #8a8a8a;">)</span>
      thumbnail-object-ids   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;thumbnail-object-id wallpapers resolutions<span style="color: #8a8a8a;">)</span>]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [download-wallpaper #<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">with-open</span> [is <span style="color: #8a8a8a;">(</span>io/input-stream %2<span style="color: #8a8a8a;">)</span>]
                              <span style="color: #8a8a8a;">(</span>store/put <span style="color: #00cdcd;">:file-system</span> store-base %1 is<span style="color: #8a8a8a;">))</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> download-wallpaper library-object-ids source-uris<span style="color: #8a8a8a;">)))</span>
  &#8230;<span style="color: #8a8a8a;">)</span>
</pre>

</div>

</div>

<div id="outline-container-10-6-8" class="outline-4">
<h4 id="sec-10-6-8"><span class="section-number-4">10.6.8</span> Thumbnailization &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-8">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [-&gt;thumbnail-resolution <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">comp</span> <span style="color: #00cdcd;">:thumbnail-resolution</span> <span style="color: #00cdcd;">:wallpaper</span><span style="color: #8a8a8a;">)</span>
      resolutions            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;thumbnail-resolution importable-wallpapers<span style="color: #8a8a8a;">)</span>
      wallpapers             <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> <span style="color: #00cdcd;">:wallpaper</span> importable-wallpapers<span style="color: #8a8a8a;">)</span>
      -&gt;library-object-id    #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;library-object-id %1 <span style="color: #00cdcd;">"library"</span> %2<span style="color: #8a8a8a;">)</span>
      library-object-ids     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;library-object-id wallpapers resolutions<span style="color: #8a8a8a;">)</span>
      -&gt;thumbnail-object-id  #<span style="color: #8a8a8a;">(</span>lib/wallpaper-&gt;thumbnail-object-id %1 <span style="color: #00cdcd;">"thumbnails"</span> %2<span style="color: #8a8a8a;">)</span>
      thumbnail-object-ids   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> -&gt;thumbnail-object-id wallpapers resolutions<span style="color: #8a8a8a;">)</span>]
  &#8230;
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [create-thumbnail <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">partial</span> store/create-thumbnail <span style="color: #00cdcd;">:file-system</span> store-base<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> create-thumbnail library-object-ids thumbnail-object-ids<span style="color: #8a8a8a;">))))</span>
</pre>


</div>

</div>

<div id="outline-container-10-6-9" class="outline-4">
<h4 id="sec-10-6-9"><span class="section-number-4">10.6.9</span> Thumbnailization &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-9">





<pre class="src src-clojure"><span style="color: #5c5cff; font-weight: bold;">;;; </span><span style="color: #5c5cff; font-style: italic;">wallpaper-manager-core.store.store</span>
<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmulti</span> <span style="color: #0000ee;">create-thumbnail</span> <span style="color: #00cdcd; font-style: italic;">"Create a thumbnail in the store &#8230;"</span> method<span style="color: #8a8a8a;">)</span>

<span style="color: #5c5cff; font-weight: bold;">;;; </span><span style="color: #5c5cff; font-style: italic;">wallpaper-manager-core.store.file-system</span>
<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmethod</span> <span style="color: #0000ee;">create-thumbnail</span> <span style="color: #00cdcd;">:file-system</span> [_ base from-object-id to-object-id]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [from <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">get</span> <span style="color: #00cdcd;">:file-system</span> base from-object-id<span style="color: #8a8a8a;">)</span>
        to   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">get</span> <span style="color: #00cdcd;">:file-system</span> base to-object-id<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span>fs/mkdirs <span style="color: #8a8a8a;">(</span>fs/parent to<span style="color: #8a8a8a;">))</span>
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [thumbnail-java-image <span style="color: #8a8a8a;">(</span>image/scale from<span style="color: #8a8a8a;">)</span>
          thumbnail-image      <span style="color: #8a8a8a;">(</span>image/java-image-&gt;image from thumbnail-java-image<span style="color: #8a8a8a;">)</span>]
      <span style="color: #8a8a8a;">(</span>image/write thumbnail-java-image <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:extension</span> thumbnail-image<span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span>io/file to<span style="color: #8a8a8a;">)))</span>
    to-object-id<span style="color: #8a8a8a;">))</span>
</pre>

</div>

</div>

<div id="outline-container-10-6-10" class="outline-4">
<h4 id="sec-10-6-10"><span class="section-number-4">10.6.10</span> Delete the Temporary Files &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-10-6-10">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dorun</span>
 <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> fs/delete <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> fs/exists? <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> string? source-uris<span style="color: #8a8a8a;">))))</span>
</pre>


</div>
</div>

</div>

<div id="outline-container-10-7" class="outline-3">
<h3 id="sec-10-7"><span class="section-number-3">10.7</span> Send the Response &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-7">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defmethod</span> <span style="color: #0000ee;">wallpaper-post-route</span> <span style="color: #00cdcd;">"application/json;q=0.0"</span>
  [_ username title merge source <span style="color: #ff0000;">sourceUri</span>]
  {<span style="color: #00cdcd;">:pre</span> [<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">or</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">vector?</span> <span style="color: #ff0000;">sourceUri</span><span style="color: #8a8a8a;">)</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">string?</span> <span style="color: #ff0000;">sourceUri</span><span style="color: #8a8a8a;">))</span>]}
  <span style="color: #8a8a8a;">(</span>utf8-json-response
   <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [wallpapers &#8230;
         -&gt;path     <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">fn</span> [wallpaper]
                      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">str</span> <span style="color: #00cdcd;">"/user/"</span>
                           username
                           <span style="color: #00cdcd;">"/wallpaper/"</span>
                           <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">java.net.URLEncoder/encode</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cdcd;">:title</span> %<span style="color: #8a8a8a;">)</span> <span style="color: #00cdcd;">"UTF-8"</span><span style="color: #8a8a8a;">)))</span>
         wallpapers <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">dissoc</span> % <span style="color: #00cdcd;">:imported-at</span><span style="color: #8a8a8a;">)</span> wallpapers<span style="color: #8a8a8a;">)</span>
         wallpapers <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">map</span> #<span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">assoc</span> % <span style="color: #00cdcd;">:location</span> <span style="color: #8a8a8a;">(</span>-&gt;path %<span style="color: #8a8a8a;">))</span> wallpapers<span style="color: #8a8a8a;">)</span>]
     <span style="color: #8a8a8a;">(</span>json/generate-string wallpapers<span style="color: #8a8a8a;">))))</span>
</pre>


</div>
</div>

</div>

<div id="outline-container-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> But what about Base64? &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-11">





<pre class="src src-js">{
  <span style="color: #00cdcd;">'title'</span>: <span style="color: #00cdcd;">'foo'</span>,
  <span style="color: #00cdcd;">'source'</span>: <span style="color: #00cdcd;">'http://localhost/foo/'</span>,
  <span style="color: #00cdcd;">'sourceUri'</span>: [
    <span style="color: #00cdcd;">'iVBORw0KGgoAAA&#8230;ggg=='</span>,
    <span style="color: #00cdcd;">'aBGoAAt0wwgggg&#8230;axx=='</span>
  ]
}
</pre>



</div>

<div id="outline-container-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-11-1">


<ul>
<li>Disadvantages

<ul>
<li>Client's with low-bandwidth get hammered.

</li>
<li>Same Origin Policy!
</li>
</ul>

</li>
</ul>


</div>

</div>

<div id="outline-container-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> The Punchline &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-2">


<ul>
<li>Same Origin Data Good
</li>
<li>Cross-Domain Data Bad

<p>
     <img src="images/good-bad.jpg"  alt="images/good-bad.jpg" />
</p></li>
</ul>



</div>

<div id="outline-container-11-2-1" class="outline-4">
<h4 id="sec-11-2-1"><span class="section-number-4">11.2.1</span> How to get Same Origin image data to the back end and imported.</h4>
<div class="outline-text-4" id="text-11-2-1">


<ul>
<li>Use HTML Canvas to get a datURL.
</li>
<li>Send it to Wallpaperrr via postMessage and JSON
</li>
<li>Implement an extension and java-image multimethod for (class (byte-array 1))
</li>
<li>Everything else Just Works™
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> Client-Side Concerns</h3>
<div class="outline-text-3" id="text-11-3">



</div>

<div id="outline-container-11-3-1" class="outline-4">
<h4 id="sec-11-3-1"><span class="section-number-4">11.3.1</span> Base64 encoding &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-11-3-1">





<pre class="src src-javascript">wallpaperrrBookmarkletImport.importData = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">importData</span>) {
  <span style="color: #5c5cff; font-weight: bold;">// </span><span style="color: #5c5cff; font-style: italic;">self.imgsLoaded(importData);</span>
  self.importDataToBase64(importData);
};
</pre>


</div>

</div>

<div id="outline-container-11-3-2" class="outline-4">
<h4 id="sec-11-3-2"><span class="section-number-4">11.3.2</span> Base64 encoding &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-11-3-2">





<pre class="src src-javascript">wallpaperrrBookmarkletImport.importDataToBase64 = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">importData</span>) {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">countdownLatch</span>, <span style="color: #0000ee;">i</span>;
  countdownLatch = {};
  <span style="color: #00cd00;">for</span> (i = 0; i &lt; importData.sourceUri.length; i += 1) {
    countdownLatch[importData.sourceUri[i]] = <span style="color: #00cdcd;">true</span>;
    self.loadImageFile(
      importData.sourceUri[i],
      <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">base64String</span>) {
        imageUrls.push(base64String);
        <span style="color: #00cd00;">delete</span> countdownLatch[importData.sourceUri[i]];
        <span style="color: #00cd00;">if</span> (0 === Object.keys(countdownLatch).length) {
          importData.sourceUri = imageUrls;
          self.imgsLoaded(importData);
        }
      });
  }
};
</pre>


</div>

</div>

<div id="outline-container-11-3-3" class="outline-4">
<h4 id="sec-11-3-3"><span class="section-number-4">11.3.3</span> Base64 encoding &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-11-3-3">





<pre class="src src-javascript">wallpaperrrBookmarkletImport.loadImageFile = <span style="color: #00cd00;">function</span> (<span style="color: #0000ee;">sURL</span>, <span style="color: #0000ee;">fCallback</span>) {
  <span style="color: #00cd00;">var</span> <span style="color: #0000ee;">img</span> = <span style="color: #00cd00;">new</span> <span style="color: #cdcd00;">Image</span>();
  img.src = sURL;
  img.onload = <span style="color: #00cd00;">function</span> () {
    self.canvas.width = <span style="color: #00cdcd;">this</span>.width;
    self.canvas.height = <span style="color: #00cdcd;">this</span>.height;
    self.ctx.clearRect(0, 0, <span style="color: #00cdcd;">this</span>.width, <span style="color: #00cdcd;">this</span>.height);
    self.ctx.drawImage(<span style="color: #00cdcd;">this</span>, 0, 0);
    fCallback.call(<span style="color: #00cdcd;">this</span>, self.dataUriToRawBase64(self.canvas.toDataURL()));
  };
};
</pre>



</div>

<div id="outline-container-11-3-3-1" class="outline-5">
<h5 id="sec-11-3-3-1"><span class="section-number-5">11.3.3.1</span> notes &nbsp;&nbsp;&nbsp;<span class="tag"><span class="notes">notes</span></span></h5>
<div class="outline-text-5" id="text-11-3-3-1">


<ul>
<li>dataURIs are not base64 data
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-11-3-4" class="outline-4">
<h4 id="sec-11-3-4"><span class="section-number-4">11.3.4</span> I don't fully understand what the Same Origin Policy effects. In my case, I could load an image but the image's origin-clean flag was set to false and thus I couldn't actually obtain the image data.</h4>
<div class="outline-text-4" id="text-11-3-4">


<p>
    <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#security-with-canvas-elements">http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#security-with-canvas-elements</a>
</p>
</div>
</div>

</div>

<div id="outline-container-11-4" class="outline-3">
<h3 id="sec-11-4"><span class="section-number-3">11.4</span> Server-Side Concerns</h3>
<div class="outline-text-3" id="text-11-4">



</div>

<div id="outline-container-11-4-1" class="outline-4">
<h4 id="sec-11-4-1"><span class="section-number-4">11.4.1</span> Decoding Base64 data &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-11-4-1">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">expand-source-uris</span> [source-uris]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">loop</span> [expanded-source-uris       #{}
         [source-uri &amp; source-uris] <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">filter</span> importable-uri? source-uris<span style="color: #8a8a8a;">)</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if</span> source-uri
      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">cond</span> &#8230;

            &#8230;

            <span style="color: #8a8a8a;">(</span>str-&gt;base64-byte-array source-uri<span style="color: #8a8a8a;">)</span>
            <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">recur</span> <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">conj</span> expanded-source-uris
                         <span style="color: #8a8a8a;">(</span>str-&gt;base64-byte-array source-uri<span style="color: #8a8a8a;">))</span>
                   source-uris<span style="color: #8a8a8a;">)</span>

            &#8230;<span style="color: #8a8a8a;">)</span>
      expanded-source-uris<span style="color: #8a8a8a;">)))</span>
</pre>


</div>

</div>

<div id="outline-container-11-4-2" class="outline-4">
<h4 id="sec-11-4-2"><span class="section-number-4">11.4.2</span> Decoding Base64 data &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h4>
<div class="outline-text-4" id="text-11-4-2">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">str-&gt;base64-byte-array</span> [str]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">try</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">javax.xml.bind.DatatypeConverter/parseBase64Binary</span> str<span style="color: #8a8a8a;">)</span>
       <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">catch</span> <span style="color: #ff0000;">Exception</span> e
         <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">comment</span> <span style="color: #00cdcd;">"NB: safe to ignore. Means base64 decoding failed."</span><span style="color: #8a8a8a;">))))</span>
</pre>


</div>
</div>
</div>

</div>

<div id="outline-container-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Setting a URLConnection's User-Agent string &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-12">





<pre class="src src-clojure"><span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">defn</span> <span style="color: #0000ee;">uri-input-stream-with-user-agent</span> [url]
  <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">if-let</span> [url <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">try</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">java.net.URL.</span> url<span style="color: #8a8a8a;">)</span>
                    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">catch</span> <span style="color: #ff0000;">java.net.MalformedURLException</span> e
                      <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">comment</span> <span style="color: #00cdcd;">"NB: OK to ignore. URL does not exist."</span><span style="color: #8a8a8a;">)))</span>]
    <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">let</span> [con <span style="color: #8a8a8a;">(</span><span style="color: #00cd00;">doto</span> <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.openConnection</span> url<span style="color: #8a8a8a;">)</span>
                <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.setRequestMethod</span> <span style="color: #00cdcd;">"GET"</span><span style="color: #8a8a8a;">)</span>
                <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.setRequestProperty</span> <span style="color: #00cdcd;">"User-Agent"</span> <span style="color: #00cdcd;">"Mozilla &#8230;"</span><span style="color: #8a8a8a;">)</span>
                <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.connect</span><span style="color: #8a8a8a;">))</span>]
      <span style="color: #8a8a8a;">(</span><span style="color: #ff0000;">.getInputStream</span> con<span style="color: #8a8a8a;">))))</span>
</pre>


</div>

</div>

<div id="outline-container-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> Further experiments &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-13">

<ul>
<li>Browser Extensions
</li>
</ul>


</div>

</div>

<div id="outline-container-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> In Conclusion &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-14">

<ul>
<li>Facepalm!
</li>
<li>Base64 Is Easy to Get
</li>
<li>Base64 Is Easy to Process
</li>
<li>User-Agent Sniffing Bad!
</li>
</ul>


</div>

</div>

<div id="outline-container-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> Thanks! Questions? &nbsp;&nbsp;&nbsp;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-15">


<ul>
<li><a href="http://blog.wallpaperrr.cc">blog.wallpaperrr.cc</a>
</li>
<li><a href="https://twitter.com/wallpaperrr">@wallpaperrr</a>
</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Code_snippets/Canvas">MDN Canvas Code Snippets</a>
</li>
<li><a href="http://clojure.org/">Clojure.org</a>
</li>
<li><a href="https://twitter.com/timvisher">@timvisher</a>
</li>
</ul>


</div>

</div>

<div id="outline-container-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> </h2>
<div class="outline-text-2" id="text-16">







<script type="text/javascript" src="org-html-slideshow.js"></script>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2013-04-25</p>
<p class="author">Author: Tim Visher</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.3f with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
